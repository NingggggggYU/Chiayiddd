<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" sizes="16x16" href="./caldbs.ico">
    <link rel="shortcut icon" sizes="16x16" href="./caldbs.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="./appleicon.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中華航空系統登入驗證 / China Airlines System Login Verification</title>
    <style>
        .version-text {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #808080;
            font-weight: bold;
            z-index: 1000;
        }

        #ip-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #808080;
            font-weight: bold;
            z-index: 1000;
        }

        .password-toggle {
            position: absolute;
            right: 4px;
            top: 20px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            z-index: 100;
        }

        .password-toggle img {
            width: 24px;
            height: 24px;
        }
    </style>
    <script src="https://cdn.auth0.com/js/auth0/9.18/auth0.min.js"></script>
</head>
<body>
    <div id="main">
        <div class="version-text">Version : 24.28</div>
        <form id="login-form" class="login-container">
            <div id="main-header">
                <div>
                    <img src="chinaairlinesicon.png" alt="China Airlines Logo">
                </div>
                <h1 id="page-title">中華航空系統登入驗證</h1>
                <p id="page-title-en">China Airlines System Login Verification</p>
            </div>

            <div id="main-content" class="login-inputs">
                <div class="a-form-control">
                    <label class="form-label" for="username">使用者名稱 / Your ID</label>
                    <input class="input-field" placeholder="" id="uname" type="text" name="uname">
                </div>
                <div class="a-form-control" style="position: relative; display:inline-block; width:100%">
                    <label class="form-label" for="password">密碼 / Password</label>
                    <input class="input-field" placeholder="" id="pass" type="password" name="pass" autocomplete="off">
                    <button type="button" id="toggle-password" class="password-toggle">
                        <img src="eye-icon.svg" alt="Show/Hide Password" id="password-icon">
                    </button>
                </div>

                <input type="hidden" name="login-form-type" value="pwd">
                <input type="hidden" name="token" value="Unknown">

                <div class="error-box" id="error-box">
                    <img style="float:left" src="error.png">
                    <div id="errId"></div>
                </div>

                <p class="a-form-control-exe">
                    <button id="btn-login" type="button" class="btn btn-primary">登入 / Login</button>
                </p>

                <div class="sub-links">
                    <p class="text-center">
                        <a href="https://hdqweb02.china-airlines.com/webjc/brief/choose.action">簽派簡報系統 Dispatch Briefing System</a>
                    </p>
                </div>

                <div id="ip-container">
                    <span id="ip-address">Loading IP address...</span>
                </div>
            </div>
        </form>
    </div>

    <script>
        const auth0 = new Auth0({
            domain: 'dev-5m5rsaavaelf0ss3.us.auth0.com',
            clientID: 'ldVbBX9hxFRpLfvYbEfQSavq47lZI3lX',
            redirectUri: window.location.origin,
            responseType: 'token id_token',
            scope: 'openid profile email'
        });

        function handleAuthentication() {
            auth0.parseHash((err, authResult) => {
                if (authResult && authResult.accessToken && authResult.idToken) {
                    // 登入成功，儲存 token
                    localStorage.setItem('accessToken', authResult.accessToken);
                    window.location.hash = '';
                    // 這裡可以更新 UI 或顯示用戶信息
                } else if (err) {
                    console.error(err);
                }
            });
        }

        function isAuthenticated() {
            return !!localStorage.getItem('accessToken');
        }

        if (!isAuthenticated()) {
            auth0.authorize(); // 重定向到 Auth0 登入
        } else {
            handleAuthentication(); // 處理登入回調
        }

        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ip-address').textContent = data.ip;
            })
            .catch(error => {
                document.getElementById('ip-address').textContent = 'Unable to retrieve IP address';
            });

        const passwordField = document.getElementById('pass');
        const togglePasswordButton = document.getElementById('toggle-password');
        const passwordIcon = document.getElementById('password-icon');

        function togglePasswordVisibility() {
            if (passwordField.type === 'password') {
                passwordField.type = 'text';  // Show password
                passwordIcon.src = 'eye-close-icon.svg';  // Change icon to indicate password is visible
            } else {
                passwordField.type = 'password';  // Hide password
                passwordIcon.src = 'eye-icon.svg';  // Change icon back to original
            }
        }

        togglePasswordButton.addEventListener('click', togglePasswordVisibility);

        // Desktop behavior
        togglePasswordButton.addEventListener('mousedown', function() {
            passwordField.type = 'text';  // Show password
        });
    
        togglePasswordButton.addEventListener('mouseup', function() {
            passwordField.type = 'password';  // Hide password
        });
    
        togglePasswordButton.addEventListener('mouseleave', function() {
            passwordField.type = 'password';  // Hide password when cursor leaves the button
        });
    </script>
</body>
</html>
